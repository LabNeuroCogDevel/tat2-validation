#!/usr/bin/env bash
#
# combine and compute linear warp between mean func files in hallquist pipeline
#
# 20240926WF - init
# 20241022WF - move script, add tests to not rerun
#
mkdir -p "$(dirname "$0")"/all_nii && cd "$_" || exit 1

test -r all_meants.nii.gz ||
  4dConcatSubBriks -o all_meants.nii.gz -- meants/*.nii.gz
test -r mean_meants.nii.gz ||
   3dMean -prefix mean_meants.nii.gz meants/*nii.gz
test -r Rrpy_Tslp.1D ||
   3dvolreg -dfile Rrpy_Tslp.1D -base mean_meants.nii.gz -prefix all_meants_mc.nii.gz all_meants.nii.gz

test -r all_meants_enorm.1D ||
  1d_tool.py -infile Rrpy_Tslp.1D'[1..6]' -collapse_cols enorm -write - |
    paste <(3dinfo -label all_meants.nii.gz |tr '|' '\n') - > all_meants_enorm.1D

test -r bad_alignments.csv ||
  Rscript - "library(dplyr); read.table('all_meants_enorm.1D',col.names=c('ld8','enorm'))%>%mutate(z=abs(scale(enorm))) %>% filter(z>2) %>% arrange(-z) %>% write.csv(stdout(),row.names=F,quote=F)" > bad_alignments.csv
#ld8,enorm,z
#11581_20191018,24.624,6.78275947136027
#11346_20191106,22.5224,6.14069723109524
#11558_20191023,22.0637,6.00055926496963
#11489_20191125,21.9207,5.95687117001441
#11677_20200115,21.0389,5.68747143482898
#11581_20191018,20.9935,5.67360122845858
#11346_20191106,20.3536,5.47810464131279
#11575_20190823,19.9943,5.36833448384837
#11575_20190823,18.6015,4.94281854920755
#11338_20200109,15.7281,4.06496280064572
#11338_20200109,15.6187,4.03153988044921
#11536_20191218,14.1613,3.58628792529016
#11457_20151216,13.7505,3.46078394341879
#11451_20170728,13.2826,3.31783527468068
#11484_20190731,13.0632,3.25080612759553
#11557_20191214,12.1105,2.95974565162461
#11641_20200102,11.9848,2.92134289962551
#11489_20191125,11.5104,2.77640840838944
#11484_20190731,11.4889,2.76983991858847
#11677_20200115,11.343,2.725265841288
#11449_20170608,11.2155,2.68631316921254
#11595_20200123,11.1579,2.66871572676904
#11536_20191218,10.8035,2.56044257395693
#11592_20200820,10.5201,2.47386071304567
#11641_20200102,10.1341,2.35593340778192
#11522_20190824,9.93164,2.29407961963762
#11639_20200206,9.90338,2.28544587443877
#11671_20200129,9.52696,2.17044536602587
#11474_20191105,9.3845,2.12692224709355
#11557_20191214,9.30291,2.10199559207679
